{
  "hash": "d14f00cd7e3d1a79333cec42a3a49ec1",
  "result": {
    "markdown": "---\ntitle: \"Fronteira Eficiente\"\nauthor: \"Ricardo Accioly\"\ndate: \"2022-11-02\"\noutput:\n html_document:\n    toc: yes\n    code_download: yes\n---\n\n::: {.cell}\n\n```{.r .cell-code}\n# parametros para imagens\nknitr::opts_chunk$set(\n  fig.width = 9,\n  fig.asp = 0.618,\n  fig.retina = 3,\n  dpi = 300,\n  out.width = \"80%\"\n)\nlibrary(quantmod)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nCarregando pacotes exigidos: xts\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nCarregando pacotes exigidos: zoo\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'zoo'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nCarregando pacotes exigidos: TTR\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nRegistered S3 method overwritten by 'quantmod':\n  method            from\n  as.zoo.data.frame zoo \n```\n:::\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages\n───────────────────────────────────────\ntidyverse 1.3.2 ──\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ ggplot2 3.3.6     ✔ purrr   0.3.4\n✔ tibble  3.1.8     ✔ dplyr   1.0.9\n✔ tidyr   1.2.0     ✔ stringr 1.4.0\n✔ readr   2.1.2     ✔ forcats 0.5.1\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::first()  masks xts::first()\n✖ dplyr::lag()    masks stats::lag()\n✖ dplyr::last()   masks xts::last()\n```\n:::\n\n```{.r .cell-code}\nlibrary(xts)\nlibrary(PerformanceAnalytics)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'PerformanceAnalytics'\n\nThe following object is masked from 'package:graphics':\n\n    legend\n```\n:::\n\n```{.r .cell-code}\nlibrary(IntroCompFinR)\nlibrary(fPortfolio)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'fPortfolio' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nCarregando pacotes exigidos: timeDate\n\nAttaching package: 'timeDate'\n\nThe following objects are masked from 'package:PerformanceAnalytics':\n\n    kurtosis, skewness\n\nCarregando pacotes exigidos: timeSeries\n\nAttaching package: 'timeSeries'\n\nThe following object is masked from 'package:zoo':\n\n    time<-\n\nCarregando pacotes exigidos: fBasics\n\nAttaching package: 'fBasics'\n\nThe following objects are masked from 'package:PerformanceAnalytics':\n\n    kurtosis, skewness\n\nThe following object is masked from 'package:TTR':\n\n    volatility\n\nCarregando pacotes exigidos: fAssets\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'fAssets' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'fPortfolio'\n\nThe following object is masked from 'package:IntroCompFinR':\n\n    getPortfolio\n```\n:::\n:::\n\n\n## Fronteira Eficiente\n\nNeste exercício vamos construir uma fronteira eficiente a partir de um conjunto de ativos.\n\n## Selecionando Ações\n\nVamos selecionar 4 ações de empresas da bolsa BOVESPA no periodo de 2018 a 2022.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_inicio = \"2018-01-01\" #data de início da análise\ndata_fim = \"2022-09-30\" #data de fim da análise\ntickers = c(\"VALE3.SA\" , \"PETR4.SA\" , \"ELET3.SA\" , 'VIVT3.SA') \ngetSymbols(tickers,from=data_inicio, to=data_fim)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"VALE3.SA\" \"PETR4.SA\" \"ELET3.SA\" \"VIVT3.SA\"\n```\n:::\n\n```{.r .cell-code}\nv_close <- VALE3.SA[,\"VALE3.SA.Close\"]\np_close <- PETR4.SA[,\"PETR4.SA.Close\"]\ne_close <- ELET3.SA[,\"ELET3.SA.Close\"]\nvv_close <- VIVT3.SA[,\"VIVT3.SA.Close\"]\ncarteira <- merge(v_close, p_close, e_close, vv_close)\nnames(carteira) <- c(\"Vale\", \"Petrobras\", \"Eletrobras\", \"Vivo\")\nknitr::kable(head(carteira))\n```\n\n::: {.cell-output-display}\n|  Vale| Petrobras| Eletrobras|  Vivo|\n|-----:|---------:|----------:|-----:|\n| 41.72|     16.55|   18.78286| 41.40|\n| 41.47|     16.70|   18.54295| 40.20|\n| 41.64|     16.73|   18.42300| 40.64|\n| 42.29|     16.83|   18.25306| 40.74|\n| 43.23|     17.03|   18.37302| 41.17|\n| 43.07|     17.03|   17.64329| 41.06|\n:::\n:::\n\n\n## Calculando Retornos\n\n\n::: {.cell}\n\n```{.r .cell-code}\nretornos_ativos <- carteira %>% \n  PerformanceAnalytics::Return.calculate(. ,method = 'discrete') %>%\n  na.omit()\nxts::first(retornos_ativos,10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                   Vale    Petrobras   Eletrobras         Vivo\n2018-01-03 -0.005992330  0.009063566 -0.012772761 -0.028985530\n2018-01-04  0.004099301  0.001796347 -0.006469034  0.010945224\n2018-01-05  0.015610039  0.005977286 -0.009224069  0.002460704\n2018-01-08  0.022227453  0.011883601  0.006571774  0.010554639\n2018-01-09 -0.003701133  0.000000000 -0.039717100 -0.002671776\n2018-01-10 -0.013930787 -0.013505695 -0.040226613 -0.012664393\n2018-01-11  0.019543159  0.026785775  0.015348274  0.040207128\n2018-01-12  0.005773672  0.002898493 -0.022674428 -0.009011075\n2018-01-15 -0.001836923  0.002890231  0.013087482 -0.006939483\n2018-01-16 -0.026915159  0.017291066  0.011156675  0.015662699\n```\n:::\n:::\n\n\n## Retornos esperados e Volatilidade diária\n\nPara obtermos a fronteira eficiente e, consequentemente, a carteira ótima (carteira que maximiza o sharpe), será necessário calcular os retornos esperados, a volatilidade diária e a matriz de covariância dos ativos.\n\nPara o retorno esperado, será calculado a média da série de retornos. Já para a volatilidade, será obtida através do desvio padrão desses retornos.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#media e desvio padrao das acoes\nmedia_desvpad <- matrix(data = NA,\n                         nrow = length(tickers), \n                         ncol = 2) \n\nfor(i in c(1:length(tickers))) {\n  \n  media_desvpad[i,1] <- mean(retornos_ativos[,i]) \n  media_desvpad[i,2] <- sd(retornos_ativos[,i])\n  \n  }\n\nmedia_desvpad <- as.data.frame(media_desvpad)\n\nmedia_desvpad <- media_desvpad %>% rename(Retorno = V1) %>%\n   rename(Desv = V2)\n \nrownames(media_desvpad) <- tickers\n\n#montando matriz de covariancia \n \ncov_acoes <- cov(retornos_ativos)\nmedia_desvpad\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n              Retorno       Desv\nVALE3.SA 0.0007643202 0.02611107\nPETR4.SA 0.0009837121 0.03104884\nELET3.SA 0.0013115757 0.03529594\nVIVT3.SA 0.0001378544 0.01787284\n```\n:::\n\n```{.r .cell-code}\ncov_acoes\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                   Vale    Petrobras   Eletrobras         Vivo\nVale       6.817879e-04 0.0003539523 0.0002731316 9.710843e-05\nPetrobras  3.539523e-04 0.0009640304 0.0005328552 1.629114e-04\nEletrobras 2.731316e-04 0.0005328552 0.0012458036 1.935819e-04\nVivo       9.710843e-05 0.0001629114 0.0001935819 3.194383e-04\n```\n:::\n:::\n\n\n\n## Fronteira Eficiente\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfronteira_eficiente <- fPortfolio::portfolioFrontier(data =as.timeSeries(retornos_ativos))\n\nfrontierPlot(fronteira_eficiente,\n             pch = 20,\n             cex = 1,\n             type = \"o\",\n             lwd = 2)\n\n\nmonteCarloPoints(fronteira_eficiente,\n                 mcSteps = 5000, \n                 pch = 20,\n                 cex = 0.1,\n                 col = \"blue\")\n```\n\n::: {.cell-output-display}\n![](Aula07_files/figure-html/unnamed-chunk-5-1.png){width=80%}\n:::\n:::\n\n\n## Carteira Otima\n\nPara obtermos a carteira ótima precisamos definir um ativo livre de risco. Vamos adotar a taxa Selic como nosso ativo livre de risco.\nAqui vamos usar o pacote IntroCompFinR para obter o portfolio tangente\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndi_diario_periodo <- (1 + 0.1375)^(1/360) - 1\ncarteira_otima <- tangency.portfolio(\n   er = media_desvpad$Retorno, #retorno esperado\n   cov.mat = cov_acoes, #matriz de covariancia\n   risk.free = di_diario_periodo, #taxa livre de risco da economia\n   shorts = FALSE # parâmetro que proíbe o algoritmo de montar posições vendidas (shorts) na carteira\n )\n\npesos_otimos <- carteira_otima[[\"weights\"]]\nnames(pesos_otimos) <- c(\"Vale\", \"Petrobras\", \"Eletrobras\", \"Vivo\")\npesos_otimos\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n      Vale  Petrobras Eletrobras       Vivo \n  0.217000   0.205734   0.577265   0.000000 \n```\n:::\n:::\n\n\n\n##\n\n\n::: {.cell}\n\n```{.r .cell-code}\ner <- media_desvpad$Retorno\ndimnames(cov_acoes) <- list(c(\"Vale\", \"Petrobras\", \"Eletrobras\", \"Vivo\"),\n                        c(\"Vale\", \"Petrobras\", \"Eletrobras\", \"Vivo\"))\ncovmat <- cov_acoes\nr.free <- di_diario_periodo\ntan.port <- tangency.portfolio(\n   er , \n   covmat, \n   r.free, \n   shorts = FALSE)\ngmin.port <- globalMin.portfolio(er, covmat)\nef <- efficient.frontier(er, covmat, alpha.min=-2, alpha.max=1.5, nport=20)\nattributes(ef)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$names\n[1] \"call\"    \"er\"      \"sd\"      \"weights\"\n\n$class\n[1] \"Markowitz\"\n```\n:::\n\n```{.r .cell-code}\nplot(ef, plot.assets=TRUE, col=\"blue\", pch=16)\npoints(gmin.port$sd, gmin.port$er, col=\"green\", pch=16, cex=2)\npoints(tan.port$sd, tan.port$er, col=\"red\", pch=16, cex=2)\ntext(gmin.port$sd, gmin.port$er, labels=\"GLOBAL MIN\", pos=2)\ntext(tan.port$sd, tan.port$er, labels=\"TANGENCY\", pos=2)\nsr.tan = (tan.port$er - r.free)/tan.port$sd\nabline(a=r.free, b=sr.tan, col=\"green\", lwd=2)\n```\n\n::: {.cell-output-display}\n![](Aula07_files/figure-html/unnamed-chunk-7-1.png){width=80%}\n:::\n:::\n\n\n\n\n## Retorno Esperado da Carteira e Desvio Padrão\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedia_co <-carteira_otima[[\"er\"]]\ndesvio_co <- carteira_otima[[\"sd\"]]\nknitr::kable(cbind(media_co,desvio_co ))\n```\n\n::: {.cell-output-display}\n|  media_co| desvio_co|\n|---------:|---------:|\n| 0.0011254|  0.026733|\n:::\n:::\n\n\n\n## Retornos da Carteira\n\nVamos obter os retornos utilizando os pesos de cada ativo determinado pela carteira ótima\n\n\n::: {.cell}\n\n```{.r .cell-code}\nretornos_carteira_ot <- Return.portfolio(\n  R = retornos_ativos , #XTS dos retornos dos ativos\n  weights = pesos_otimos, #vetor com os pesos da carteira otima\n  rebalance_on = \"months\"#parametro que define a periodicidade do rebalanceamento\n)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning in Return.portfolio.geometric(R = R, weights = weights, wealth.index =\nwealth.index, : The weights for one or more periods do not sum up to 1: assuming\na return of 0 for the residual weights\n```\n:::\n\n```{.r .cell-code}\nxts::first(retornos_carteira_ot,10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           portfolio.returns\n2018-01-03     -0.0068089196\n2018-01-04     -0.0024461679\n2018-01-05     -0.0006043089\n2018-01-08      0.0111720307\n2018-01-09     -0.0232307738\n2018-01-10     -0.0284187128\n2018-01-11      0.0188373928\n2018-01-12     -0.0103914586\n2018-01-15      0.0072695410\n2018-01-16      0.0036071824\n```\n:::\n:::\n\n\n## Retornos Acumulados\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchart.CumReturns(R = retornos_carteira_ot , wealth.index = FALSE , legend.loc = 'topleft')\n```\n\n::: {.cell-output-display}\n![](Aula07_files/figure-html/unnamed-chunk-10-1.png){width=80%}\n:::\n:::\n\n\n## Carteira com Pesos Iguais\n\nVamos ver como ficaria nossa carteira caso adotassemos pesos iguais.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nretornos_pi <- Return.portfolio(\n  R = retornos_ativos , \n  weights = c(0.25, 0.25 , 0.25 , 0.25),\n  rebalance_on = 'months'\n)\nxts::first(retornos_pi,10)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           portfolio.returns\n2018-01-03      -0.009671764\n2018-01-04       0.002556962\n2018-01-05       0.003774596\n2018-01-08       0.012890867\n2018-01-09      -0.011229446\n2018-01-10      -0.019693380\n2018-01-11       0.025625367\n2018-01-12      -0.005211813\n2018-01-15       0.001454273\n2018-01-16       0.003974694\n```\n:::\n:::\n\n\n## Agrupando as duas carteiras e visualizando\n\n\n::: {.cell}\n\n```{.r .cell-code}\nretornos_carteiras <- merge.xts(retornos_carteira_ot , retornos_pi , join=\"inner\")\ncolnames(retornos_carteiras) <- c(\"Carteira Otima\", \"Carteira PI\")\n\nchart.CumReturns(R = retornos_carteiras, wealth.index = FALSE , legend.loc = 'topleft')\n```\n\n::: {.cell-output-display}\n![](Aula07_files/figure-html/unnamed-chunk-12-1.png){width=80%}\n:::\n:::\n\n\n## Indice Sharpe\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#carteira otima\nSharpeRatio(\n  R = retornos_carteiras$\"Carteira Otima\" ,\n  Rf = di_diario_periodo , \n  FUN = 'StdDev'\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                              Carteira Otima\nStdDev Sharpe (Rf=0%, p=95%):     0.02776882\n```\n:::\n\n```{.r .cell-code}\n#Carteira pesos iguais\nSharpeRatio(\n  R = retornos_carteiras$\"Carteira PI\" ,\n  Rf = di_diario_periodo , \n  FUN = 'StdDev'\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n                              Carteira PI\nStdDev Sharpe (Rf=0%, p=95%):  0.02053175\n```\n:::\n:::\n\n\n\n## Carteira Viável\n\nPodemos criar uma carteira viável com pesos iguais usando o pacote fPortfolio\n\n\n::: {.cell}\n\n```{.r .cell-code}\npiSpec <- portfolioSpec()\nnAtivos <- ncol(retornos_ativos)\nsetWeights(piSpec) <- rep(1/nAtivos, times = nAtivos)\npiPortfolio <- feasiblePortfolio(\ndata = as.timeSeries(retornos_ativos),\nspec = piSpec,\nconstraints = \"LongOnly\")\nprint(piPortfolio)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nTitle:\n MV Feasible Portfolio \n Estimator:         covEstimator \n Solver:            solveRquadprog \n Optimize:          minRisk \n Constraints:       LongOnly \n\nPortfolio Weights:\n      Vale  Petrobras Eletrobras       Vivo \n      0.25       0.25       0.25       0.25 \n\nCovariance Risk Budgets:\n      Vale  Petrobras Eletrobras       Vivo \n    0.2184     0.3128     0.3488     0.1201 \n\nTarget Returns and Risks:\n  mean    Cov   CVaR    VaR \n0.0008 0.0201 0.0460 0.0270 \n\nDescription:\n Wed Nov  2 17:45:10 2022 by user: Ricardo \n```\n:::\n:::\n\n\n## Visualizando\n\n\n::: {.cell}\n\n```{.r .cell-code}\npar(mfrow = c(2, 2))\ncol <- seqPalette(ncol(retornos_ativos), \"YlGn\")\nweights <- 100 * as.vector(getWeights(piPortfolio))\nweightedReturns <- weights * getMean(piPortfolio)\ncovRiskBudgets <- getCovRiskBudgets(piPortfolio)\nnames <- colnames(retornos_ativos)\nbarplot(height = weights, names.arg = names, horiz = TRUE, las = 1, col = col)\ntitle(main = \"Pesos do Portfolio\", xlab = \"Peso %\")\nbarplot(height = weightedReturns, names.arg = names, horiz = TRUE, las = 1, col = col)\ntitle(main = \"Retornos Ponderados\", xlab = \"Retornos poderados %\")\nbarplot(height = weights, names.arg = names, las = 1, col = col)\ntitle(main = \"Pesos do Portfolio\", xlab = \"Pesos %\")\nbarplot(height = covRiskBudgets, names.arg = names, las = 1, col = col)\ntitle(main = \"Covariancia dos Ativos\", xlab = \"Ativos\")\n```\n\n::: {.cell-output-display}\n![](Aula07_files/figure-html/unnamed-chunk-15-1.png){width=80%}\n:::\n:::\n",
    "supporting": [
      "Aula07_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}